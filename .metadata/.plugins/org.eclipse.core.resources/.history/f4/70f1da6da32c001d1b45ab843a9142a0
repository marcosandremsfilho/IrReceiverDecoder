#include "main.h"
#include "sensorIrClass.h"

extern uint16_t microsecondsTime;

SensorIR :: SensorIR(GPIO_TypeDef* Port, uint16_t Pin) {
	_Port = Port;
	_Pin = Pin;
}

void SensorIR::getTime(uint16_t microTime) {
	decision();

	if(lockInicial == 0) {
		timeON = HAL_GetTick();
		lockInicial = 1;
	} else if(lockFinal == 0 && lockInicial == 1) {
		lockFinal =1;
		timeOFF = HAL_GetTick();
		time = timeOFF - timeON;
	}
}

void SensorIR::decision() {
	if(time > 12 && time < 15) {
		decodeNECSignalFunction();
	}
}
void SensorIR::decodeNECSignalFunction() {
	if(flag == 0) {
			time2 = HAL_GetTick();
			flag = 1;
		} else if (flag == 1){
			time2 =  HAL_GetTick() - time2;
			if (time2 > 0 && time2 < 2 && bit < 32){
				decodeSignal = (decodeSignal << 1);
				bit++;
				flag = 0;
			} else if (time2 > 1 && time2 < 3 && bit < 32) {
				decodeSignal = (decodeSignal << 1) + 1;
				bit++;
				flag = 0;
			} else if (bit == 32) {
				flag = 0;
				bit = 0;
				decodeSignal = 0;
			}
		}

		Signal = decodeSignal;
}
